use App\Models\PhoneNumber;

public function handle()
{
    $telegram = new Api();
    $offset = 0;

    $this->info('Bot polling started...');

    while (true) {
        $updates = $telegram->getUpdates([
            'offset' => $offset + 1,
            'timeout' => 10,
        ]);

        foreach ($updates as $update) {
            $offset = $update->getUpdateId();

            if (isset($update['message']['text'])) {
                $chatId = $update['message']['chat']['id'];
                $text = $update['message']['text'];

                if ($text === '/start') {
                    $this->handleStart($chatId, $telegram);
                } elseif ($this->isValidPhoneNumber($text)) {
                    $this->handlePhoneNumber($text, $chatId, $telegram);
                } else {
                    $this->sendInvalidPrompt($chatId, $telegram);
                }
            }

            if (isset($update['callback_query'])) {
                $this->handleCallbackQuery($update, $telegram);
            }
        }

        sleep(1);
    }
}

private function handleStart($chatId, $telegram)
{
    $telegram->sendMessage([
        'chat_id' => $chatId,
        'text' => 'မိတ်ဆွေဖုန်းအတွက် 15K Plan သို့မဟုတ် 25K Plan ဝယ်ယူအသုံးပြုလိုပါလား။ မိတ်ဆွေရဲ့ ATOM ဖုန်းနံပါတ် (097##########) ကို ပေးပို့ပါ။'
    ]);
}

private function isValidPhoneNumber($text): bool
{
    return ctype_digit($text) && strlen($text) === 11 && preg_match('/^(097|၀၉၇)\d{8}$/u', $text);
}

private function handlePhoneNumber($text, $chatId, $telegram)
{
    $telegram->sendMessage([
        'chat_id' => $chatId,
        'text' => 'သင့်ဖုန်းနံပါတ်အား စစ်ဆေးနေပါသည်...'
    ]);

    sleep(1);

    // ✅ DB ထဲသိမ်း
    PhoneNumber::create([
        'chat_id' => $chatId,
        'phone_number' => $text,
    ]);

    // ✅ Admin Alert
    $adminChatId = env('TELEGRAM_ADMIN_CHAT_ID');
    $telegram->sendMessage([
        'chat_id' => $adminChatId,
        'text' => "📥 အသုံးပြုသူအသစ်တစ်ဦး\nChat ID: $chatId\nဖုန်းနံပါတ်: $text",
    ]);

    // ✅ Package Select Keyboard
    $keyboard = Keyboard::make()
        ->inline()
        ->row([
            Keyboard::inlineButton(['text' => '15K Plan', 'callback_data' => '15K Plan']),
            Keyboard::inlineButton(['text' => '25K Plan', 'callback_data' => '25K Plan']),
        ]);

    $telegram->sendMessage([
        'chat_id' => $chatId,
        'text' => 'မိတ်ဆွေအသုံးပြုလိုသော package ကို ရွေးပါ။',
        'reply_markup' => $keyboard,
    ]);
}

private function handleCallbackQuery($update, $telegram)
{
    $chatId = $update['callback_query']['message']['chat']['id'];
    $data = $update['callback_query']['data'];

    $this->info("User selected: " . $data);

    $responseText = match ($data) {
        '15K Plan' => 'မိတ်ဆွေ 15K Plan ကို ရွေးချယ်ခဲ့ပါသည်။',
        '25K Plan' => 'မိတ်ဆွေ 25K Plan ကို ရွေးချယ်ခဲ့ပါသည်။',
        default => 'တစ်ခုကို ရွေးချယ်ပါ။',
    };

    // First message
    $telegram->sendMessage([
        'chat_id' => $chatId,
        'text' => $responseText,
    ]);

    sleep(2);

    // Second message: Confirm payment
    $telegram->sendMessage([
        'chat_id' => $chatId,
        'text' => "ငွေပေးချေမှုအတည်ပြုရန် အောက်ပါနံပါတ်သို့ ဆက်သွယ်ပါ:\n📞 0978654321",
    ]);
}

private function sendInvalidPrompt($chatId, $telegram)
{
    $telegram->sendMessage([
        'chat_id' => $chatId,
        'text' => 'ကျေးဇူးပြု၍ ATOM ဖုန်းနံပါတ် (097##########) ကိုသာ ထည့်ပါ။'
    ]);
}
